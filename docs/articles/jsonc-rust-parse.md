---
title: "JSONCとRustで始めるパーサー入門"
emoji: "🔐"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["rust"]
published: false
---

パーサーって何やってるのか、どういう実装してるのかがなんとなくしかイメージ持ててなかったので、勉強がてら実装してみました。JSON パーサー作ってみた系の記事は結構あるので、なんとなく趣を少しだけ変えて JSONC（JSON with comment）をパーサーを wasm で公開するところまでを目標にやってみて、そこで学んだことなどを備忘録かねて残したいと思います。

## 作るもの

作るものについて少し補足です。

### JSONC

JSONC は JSON with comment のことで、[Microsoft が作ったフォーマット](https://github.com/microsoft/node-jsonc-parser)です。tsconfig や eslint など、JS 界隈だとツールチェーンの設定のフォーマットとしてよく使われています。
基本的に JSON の仕様ありきなので RFC を見つつ、Trailing Comma とコメントアウトをパースできるように実装していきます。

https://www.rfc-editor.org/rfc/rfc8259

### wasm の戻り値

wasm では JS のオブジェクトは返せないのでため、今回は`JSON.stringfy`できる文字列を返して JS 側で JSON.parse することを目指しました。正直使い勝手あまりよくないとは思いますが、自分の勉強のためって側面が強かったので実用性は少々目を瞑りました。

## パースの流れ

今回作るパーサーの主な処理の流れは以下のようになります。

1. 入力文字列(JSONC 文字列)取得
1. 字句解析(Token 作成)
1. 構文解析(AST Node 作成)
1. 出力文字(JSON 文字列)生成

### 字句解析

字句解析は入力文字を解析して、Token と呼ばれる内部表現（Class のインスタンスや Enum など）に置き換える処理を指します。文字列をフラットな Token 配列に置き換えることにより、Token に振る舞いを追加できたり全体的に処理が書きやすくなったりします。
ただし、この段階では Token 配列が生成されるだけなので構文として正しいかはわかりません。また正しい JSON 構造はツリー構造を持つので、フラットな配列では扱いづらいかと思います。そこで出てくるのが次の構文解析です。

### 構文解析

構文解析では、Token 配列を元に AST（Abstract Syntax Tree=抽象構文木）と呼ばれるツリーデータ構造を生成します。
AST はツリー構造で、Node と呼ばれる要素で構成されます。Node には空白やカンマなどの情報は持ちません。そうすることで、内部表現としてより扱いやすくなります。
この AST の生成時に、構文が無効だった場合エラーとすることで無効な構文であったことを伝えます。
ツリー構造だと構文のスコープや検証がフラットな配列と比べて容易になります。このツリー構造に対し特定の構造を許可しないような振る舞いを追加することで Lint となり、構造の出力形式を決めることでフォーマッタが実現できたりします。

#### 再帰下降構文解析

ここで構文解析の手法について軽く触れておきます。（ここらへん正直理解が薄いのでちょっと怪しいかも。。）
構文解析で一番シンプルらしいので、今回は再帰下降構文解析という手法に則りました。この手法は、AST で言うと Root -> Leaf へと下降しながら、相互再帰手続き（関数間を相互に再帰）して解析していく手法です。
以下[Wikipedia](https://dai1741.github.io/maximum-algo-2012/docs/parsing/)より引用です。

> 再帰下降構文解析（さいきかこうこうぶんかいせき、Recursive Descent Parsing）は、相互再帰型の手続き（あるいは再帰的でない同等の手続き）で構成される LL 法のトップダウン構文解析であり、各プロシージャが文法の各生成規則を実装することが多い。従って、生成されるプログラムの構造はほぼ正確にその文法を反映したものとなる。そのような実装の構文解析器を再帰下降パーサ（Recursive Descent Parser）と呼ぶ。

LL 法は文脈自由文法と呼ばれるものの 1 つらしいです。

https://www.momoyama-usagi.com/entry/info-automaton07

### AST 元に組み立て

## 字句解析

### lexer を作る

### 1 文字で完結する場合

### Number

### 文字列

### Null、Boolean

### Object、配列

## 構文解析

### token を流して tree 化していく

### 予期せぬ token が来たらちゃんとわかりやすくエラーメッセージつけよう

## JSON string を返す

### wasm の入り口を用意

### Node を stringfy

### 呼び出せば OK

## 感想

### 全体的に手続き的になってしまった

### コンビネータというのを後で知った

### エラー雑に実装したけどよくない

### なんとなーくは感じは掴めた

### まぁ役には立たないけどやってよかった

## rust tips

### anyhow

### thiserror

### todo

- tokenize するときに`_ => (),`としてるがエラーにした方が良さそう
